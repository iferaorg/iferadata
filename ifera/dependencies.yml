dependency_rules:
  # Task - refresh futures individual
  - dependent: "file:meta/futures/tasks/{interval}/{symbol}.yml"
    depends_on:
      - pattern: "s3:tensor/futures_individual/{interval}/{symbol}-{contract_code}.pt.gz"
        wildcard_expansion: "s3:raw/futures_individual/{interval}/{symbol}-{contract_code}.zip"

  # Download
  - dependent: "file:{source}/{type}/{interval}/{symbol}.{ext}"
    depends_on:
      - "s3:{source}/{type}/{interval}/{symbol}.{ext}"
    refresh_function: "ifera.file_refresh.download_file"

  # Raw
  - dependent: "s3:raw/futures_individual/{interval}/{symbol}-{contract_code}.zip"
  - dependent: "s3:raw/{type}/{interval}/{symbol}.zip"

  # Metadata
  - dependent: "s3:meta/futures/dates_raw/{symbol}.yml"
    depends_on:
      - pattern: "s3:raw/futures_individual/30m/{symbol}-{contract_code}.zip"
        wildcard_expansion: "s3:raw/futures_individual/30m/{symbol}-{contract_code}.zip"

  - dependent: "s3:meta/futures/dates/{symbol}.yml"
    depends_on:
      - "github:iferaorg/iferadata/data/instruments.yml"
      - "github:iferaorg/iferadata/data/brokers.yml"
      - "s3:meta/futures/dates_raw/{symbol}.yml"

  - dependent: "s3:meta/futures/rollover/{symbol}.yml"
    depends_on:
      - "s3:meta/futures/dates/{symbol}.yml"
      - pattern: "s3:tensor/futures_individual/30m/{symbol}-{contract_code}.pt.gz"
        wildcard_expansion: "s3:raw/futures_individual/30m/{symbol}-{contract_code}.zip"

  # Raw -> Processed
  - dependent: "s3:processed/{type}/{interval}/{symbol}.zip"
    depends_on:
      - "github:iferaorg/iferadata/data/instruments.yml"
      - "s3:raw/{type}/{interval}/{symbol}.zip"

  # Special tensors
  - dependent: "s3:tensor/futures_backadjusted/{interval}/{symbol}.pt.gz"
    where:
      interval: ["1m", "30m"]
    depends_on:
      - "s3:meta/futures/rollover/{symbol}.yml"
      - pattern: "s3:tensor/futures_individual/{interval}/{symbol}-{contract_code}.pt.gz"
        wildcard_expansion: "s3:raw/futures_individual/{interval}/{symbol}-{contract_code}.zip"

  # Processed -> Tensor
  - dependent: "s3:tensor/{type}/{interval}/{symbol}.pt.gz"
    where:
      interval: ["1m", "30m"]
    depends_on:
      - "s3:processed/{type}/{interval}/{symbol}.zip"

refresh_rules:
  # Upload
  - dependent: "s3:{source}/{type}/{interval}/{symbol}.{ext}"
    depends_on:
      - "file:{source}/{type}/{interval}/{symbol}.{ext}"
    refresh_function: "ifera.file_refresh.upload_file"

  # Fake file for metadata
  - dependent: "file:meta/futures_individual/30m/{symbol}-{contract_code}.zip"

  # Metadata
  - dependent: "file:meta/futures/dates_raw/{symbol}.yml"
    depends_on:
      - pattern: "file:meta/futures_individual/30m/{symbol}-{contract_code}.zip"
        wildcard_expansion: "s3:raw/futures_individual/30m/{symbol}-{contract_code}.zip"
    refresh_function:
      name: "ifera.file_refresh.process_futures_metadata_raw"
      list_args:
        contract_codes: contract_code

  - dependent: "file:meta/futures/dates/{symbol}.yml"
    depends_on:
      - "file:meta/futures/dates_raw/{symbol}.yml"
    refresh_function:
      name: "ifera.file_refresh.process_futures_metadata"

  - dependent: "file:meta/futures/rollover/{symbol}.yml"
    depends_on:
      - "file:meta/futures/dates/{symbol}.yml"
      - pattern: "file:tensor/futures_individual/30m/{symbol}-{contract_code}.pt.gz"
        wildcard_expansion: "s3:raw/futures_individual/30m/{symbol}-{contract_code}.zip"
    refresh_function: 
      name: "ifera.file_refresh.calculate_rollover_spec"
      list_args:
        contract_codes: contract_code

  # Raw -> Processed
  - dependent: "file:processed/futures_individual/{interval}/{symbol}-{contract_code}.zip"
    depends_on:
      - "file:raw/futures_individual/{interval}/{symbol}-{contract_code}.zip"
    refresh_function:
      name: "ifera.file_refresh.process_raw_file"
      additional_args:
        type: "futures_individual"

  - dependent: "file:processed/{type}/{interval}/{symbol}.zip"
    depends_on:
      - "file:raw/{type}/{interval}/{symbol}.zip"
    refresh_function: "ifera.file_refresh.process_raw_file"

  # Special tensors
  - dependent: "file:tensor/futures_backadjusted/{interval}/{symbol}.pt.gz"
    where:
      interval: ["1m", "30m"]
    depends_on:
      - "file:meta/futures/rollover/{symbol}.yml"
      - pattern: "file:tensor/futures_individual/{interval}/{symbol}-{contract_code}.pt.gz"
<<<<<<< HEAD
        expansion_function: "ifera.file_refresh.contract_codes_for_backadjust"
=======
        expansion_function:
          name: "ifera.file_refresh.contract_codes_for_backadjust"
          depends_on:
            - "file:meta/futures/rollover/{symbol}.yml"
>>>>>>> origin/main
    refresh_function:
      name: "ifera.file_refresh.process_futures_backadjusted_tensor"

  # Processed -> Tensor
  - dependent: "file:tensor/futures_individual/{interval}/{symbol}-{contract_code}.pt.gz"
    depends_on:
      - "file:processed/futures_individual/{interval}/{symbol}-{contract_code}.zip"
    refresh_function:
      name: "ifera.file_refresh.process_tensor_file"
      additional_args:
        type: "futures_individual"
  
  - dependent: "file:tensor/{type}/{interval}/{symbol}.pt.gz"
    where:
      interval: ["1m", "30m"]
    depends_on:
      - "file:processed/{type}/{interval}/{symbol}.zip"
    refresh_function: "ifera.file_refresh.process_tensor_file"
